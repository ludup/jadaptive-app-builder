<!DOCTYPE html>
<html lang="en" xmlns:jad="http://jadaptive.com/jadaptive">
<head>
<title>${page.template.name}</title>
</head>
<div class="wrapper">
<header jad:id="header"></header>
<main class="container mt-3">  
  <div class="row">
	<ol class="breadcrumb col-12">
	  <li class="breadcrumb-item"><a href="/app/ui/dashboard">Home</a></li>
	  <li class="breadcrumb-item active"><a href="/app/ui/tables/${page.template.resourceKey}">${page.template.name}</a></li>
	</ol>
  </div>
  <div class="row">
     <h1>${page.template.name}</h1>
  </div>
  <div class="row">
  	   <div class="col-4 offset-8">
  	   	  <div id="childDropdown">
  		  </div>
  	   </div>
  </div>
  <div class="row">
  	  <div id="tableholder" class="col-12 mb-3">
	  </div>
	  <div class="readWrite col-12 mt-3">
	  	<a href="/app/ui/create/${page.template.resourceKey}" class="btn btn-dark me-3">Create</a>
	  	<a href="/app/ui/import/${page.template.resourceKey}" class="btn btn-primary">Import</a>
	  </div>
  </div>
  <div id="searchDropdown" style="display: none">
      
  </div>

</main>
</div>
<footer jad:id="footer"></footer>
<script>
$(document).ready(function() {

	var renderPage = function() {
		debugger;
		$.getJSON('/app/api/template/' + $('#searchTable').val(), function(data) {
			if(data.success) {
				var t = data.resource;
				
				var columns = [];

				$.each(t.fields, function(idx, obj) {
					
					// TODO based off rendering template
					
					columns.push({
						title: obj.name,
						field: obj.resourceKey,
						visible: obj.searchable
					});
					
				});
				
				columns.push({
					title: 'Actions',
					formatter: function(val, obj) {
						var ret = '<a href="/app/ui/update/' + $('#searchTable').val() + '/' + obj.uuid + '" data-uuid="' + obj.uuid + '"><i class="far fa-edit"></i></a>&nbsp;';
						ret += '<a href="/app/ui/view/' + $('#searchTable').val() + '/' + obj.uuid + '" data-uuid="' + obj.uuid + '"><i class="far fa-eye"></i></a>&nbsp;';
						if(!obj.system) {
							ret += '<a class="clickDelete" href="#" data-uuid="' + obj.uuid + '"><i class="far fa-trash-alt"></i></a>';
						}
						return ret;
					}
				});

				$('#tableholder').empty();
				$('#tableholder').append('<table id="table"></table>');
				$('#table').bootstrapTable({
					sidePagination: 'server',
					totalField: 'total',
					dataField: 'rows',
					url: '/app/api/objects/' + t.resourceKey + '/table',
					pagination: true,
					columns: columns,
					search: true,
					showColumns: columns.length > 2,
					showRefresh: true,
					mobileResponsive: true,
					queryParams: function(params) {
						params['searchField'] = $('#searchValue').val();
						return params;
					}
				});
				
				$('#table').off('post-header.bs.table');
				$('#table').on('post-header.bs.table', function(e) {
				
				
					if($('#searchField').length == 0) {
						$('.search').parent().append('<div id="searchDropdownHolder" class="columns columns-right me-1 float-end"></div>');
						
						$('#searchDropdownMenu').empty();

						$.each(t.fields, function(idx, obj) {
							if(!obj.hidden && obj.searchable) {
								$('#searchDropdownMenu').append('<a data-resourcekey="' + obj.resourceKey +'" + class="clickSearch dropdown-item" href="#">' + obj.name + '</a>');
							}
						});
							
						$("#searchDropdown").appendTo("#searchDropdownHolder");
						$('#searchDropdown').show();
						
						if($('#childDropdown').find('.dropdown-item').length > 0) {
							$("#childDropdown").appendTo("#searchDropdownHolder");
							$('#childDropdown').show();
						}
						
						$('.clickSearch').click(function(e) {
							debugger;
							e.preventDefault();
							var value = $(this).data('resourcekey');
							var text = $(this).text();
							$('#searchValue').val(value);
							$('#searchText').val(text);
						});
					}

					$('.clickDelete').off('click');
					
					$('.clickDelete').on('click', function(e) {
						e.preventDefault();
						var uuid = $(this).data('uuid');
						bootbox.confirm({
						    message: "Are you sure you want to delete the entity with uuid " + uuid + "?",
						    buttons: {
						        confirm: {
						            label: 'Yes',
						            className: 'btn-success'
						        },
						        cancel: {
						            label: 'No',
						            className: 'btn-danger'
						        }
						    },
						    callback: function (result) {
						        if(result) {
						        	var url = '/app/api/objects/' + t.resourceKey + '/' + uuid;
						    		
						    		$.ajax({
						                url: url,
						                type: 'delete',
						                dataType: 'json',
						                success: function (data) {
						                	$('#table').bootstrapTable('refresh');
						                }
						            });
						        }
						    }
						});
					});
				});
			} else {
				alert(data.message);
			}
		});
	}
	
	$('#searchTable').change(renderPage);
	renderPage();
});

</script>
</body>
</html>